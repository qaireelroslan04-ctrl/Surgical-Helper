<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Surgical Helper</title>
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            /* Dark Mode (Midnight) */
            --bg-body: #000000;
            --bg-sidebar: #050505;
            --bg-card: #0a0a0a;
            --bg-box: #111111;
            --bg-input: #171717;
            --border-color: #27272a;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --accent-color: #3b82f6;
            --accent-bg: #172554;
            --accent-text: #bfdbfe;
            --header-bg: rgba(0, 0, 0, 0.85);
            --bg-tab: rgba(30, 30, 30, 0.6); /* Dark translucent tab */
            --shadow-card: none;
            
            /* Special Box Colors (Dark) */
            --box-green-bg: rgba(6, 78, 59, 0.3); --box-green-border: #059669; --box-green-text: #d1fae5;
            --box-blue-bg: rgba(30, 58, 138, 0.3); --box-blue-border: #2563eb; --box-blue-text: #dbeafe;
            --box-red-bg: rgba(127, 29, 29, 0.3); --box-red-border: #dc2626; --box-red-text: #fee2e2;
            --box-purple-bg: rgba(88, 28, 135, 0.3); --box-purple-border: #9333ea; --box-purple-text: #f3e8ff;
            --box-yellow-bg: rgba(120, 53, 15, 0.3); --box-yellow-border: #d97706; --box-yellow-text: #fef3c7;
        }

        [data-theme="light"] {
            /* Light Mode */
            --bg-body: #f0f4f8;
            --bg-sidebar: #ffffff;
            --bg-card: #ffffff;
            --bg-box: #f8fafc;
            --bg-input: #f1f5f9;
            --border-color: #e2e8f0;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --accent-color: #0284c7;
            --accent-bg: #e0f2fe;
            --accent-text: #0c4a6e;
            --header-bg: rgba(255, 255, 255, 0.95);
            --bg-tab: rgba(255, 255, 255, 0.85); /* Light translucent tab */
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);

            --box-green-bg: #f0fdf4; --box-green-border: #22c55e; --box-green-text: #14532d;
            --box-blue-bg: #eff6ff; --box-blue-border: #3b82f6; --box-blue-text: #1e3a8a;
            --box-red-bg: #fef2f2; --box-red-border: #ef4444; --box-red-text: #7f1d1d;
            --box-purple-bg: #faf5ff; --box-purple-border: #a855f7; --box-purple-text: #581c87;
            --box-yellow-bg: #fffbeb; --box-yellow-border: #f59e0b; --box-yellow-text: #78350f;
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            height: 100dvh; /* Dynamic viewport height fix for mobile */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.6;
        }

        /* --- HEADER --- */
        header {
            background-color: var(--header-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            z-index: 50;
            flex-shrink: 0; /* Prevent header from shrinking */
        }
        .logo-area { display: flex; align-items: center; gap: 0.75rem; cursor: pointer; }
        h1 { font-size: 1.25rem; font-weight: 800; letter-spacing: -0.02em; color: var(--accent-color); }
        .mode-badge { 
            background: var(--bg-input); color: var(--text-muted); border: 1px solid var(--border-color);
            font-size: 0.65rem; padding: 2px 8px; border-radius: 4px; font-weight: 600; text-transform: uppercase; 
            margin-left: 10px;
        }

        /* --- HOME PAGE VIEW --- */
        #home-view {
            display: flex;
            flex: 1;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            padding: 2rem;
            animation: fadeIn 0.5s ease-out;
            overflow-y: auto; /* Ensure home page scrolls if content is tall */
        }
        .home-title {
            font-size: 3rem;
            font-weight: 900;
            text-align: center;
            background: linear-gradient(135deg, var(--accent-color), var(--box-purple-border));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }
        .card-container {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 1000px;
            width: 100%;
        }
        .nav-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 3rem 2rem;
            width: 300px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        .nav-card:hover {
            border-color: var(--accent-color);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
        }
        .card-icon { font-size: 4rem; margin-bottom: 0.5rem; }
        .card-title { font-size: 1.5rem; font-weight: 700; color: var(--text-main); }
        .card-desc { color: var(--text-muted); font-size: 0.9rem; }

        /* --- APP VIEW (Long/Short Case) --- */
        #app-view { 
            display: none; 
            flex: 1; 
            overflow: hidden; 
            position: relative; 
            min-height: 0; /* Crucial for nested flex scrolling */
        } 
        
        aside {
            width: 340px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* Smooth scroll iOS */
            z-index: 40;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .search-box {
            padding: 1rem;
            background: var(--bg-sidebar);
            position: sticky; top: 0; z-index: 5;
            border-bottom: 1px solid var(--border-color);
        }
        .search-input {
            width: 100%; padding: 0.85rem;
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            border-radius: 0.5rem; font-size: 0.95rem; outline: none;
            transition: border-color 0.2s;
        }
        .search-input:focus { border-color: var(--accent-color); }

        .case-list { padding: 0.5rem; padding-bottom: 3rem; }
        
        .category-header {
            font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em;
            color: var(--text-muted); font-weight: 800;
            padding: 1.5rem 0.5rem 0.5rem 0.75rem;
            margin-top: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            opacity: 0.9;
        }
        .category-header:first-child { margin-top: 0; padding-top: 0.5rem; }

        .case-btn {
            width: 100%; text-align: left; padding: 1rem 0.75rem;
            background: none; border: none; cursor: pointer;
            color: var(--text-main); font-weight: 500; font-size: 0.95rem;
            border-radius: 0.5rem; margin-bottom: 4px;
            transition: all 0.2s;
        }
        .case-btn:hover { background-color: var(--bg-input); }
        .case-btn.active {
            background-color: var(--accent-bg); color: var(--accent-text);
            font-weight: 700; border-left: 3px solid var(--accent-color);
        }

        main {
            flex: 1; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; /* Smooth scroll iOS */
            padding: 0 2rem 4rem 2rem;
            background-color: var(--bg-body);
            scroll-behavior: smooth;
        }

        .welcome-state {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; text-align: center; color: var(--text-muted); padding: 2rem;
        }

        .case-details { max-width: 1000px; margin: 0 auto; display: none; padding-bottom: 6rem; }
        .case-details.active { display: block; animation: fadeIn 0.4s ease-in-out; }

        .details-header {
            margin-bottom: 1rem; border-bottom: 1px solid var(--border-color);
            padding: 2rem 0 1rem 0; display: flex; flex-direction: column; gap: 0.5rem;
        }
        .category-tag { font-size: 0.8rem; color: var(--accent-color); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        h2 { font-size: 2rem; color: var(--text-main); font-weight: 800; line-height: 1.2; margin: 0; }

        .theme-toggle {
            background: none; border: 1px solid var(--border-color); color: var(--text-main);
            cursor: pointer; padding: 0.5rem; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; width: 40px; height: 40px;
        }
        .theme-toggle svg { width: 20px; height: 20px; fill: currentColor; }

        /* --- FLOATING TABS --- */
        .tabs-wrapper {
            position: sticky; top: 0; z-index: 10;
            padding: 1rem 0 1rem 0;
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            background-color: transparent;
            mask-image: linear-gradient(to bottom, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 85%, transparent 100%);
            margin: 0 -2rem 1.5rem -2rem; 
            padding-left: 2rem; padding-right: 2rem;
        }
        
        .tabs {
            display: flex; padding: 0.25rem;
            overflow-x: auto; gap: 0.75rem;
            scrollbar-width: none; -ms-overflow-style: none;
        }
        .tabs::-webkit-scrollbar { display: none; }
        
        .tab-btn {
            flex: 0 0 auto; padding: 0.65rem 1.2rem; 
            border: 1px solid var(--border-color); 
            background: var(--bg-tab); /* UPDATED: Uses variable */
            cursor: pointer; border-radius: 2rem; 
            font-weight: 600; color: var(--text-muted);
            font-size: 0.9rem; white-space: nowrap; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .tab-btn:hover { background: var(--bg-input); color: var(--text-main); transform: translateY(-1px); }
        
        .tab-btn.active { 
            background: var(--bg-card); color: var(--text-main); 
            border-color: var(--accent-color);
            box-shadow: 0 8px 15px rgba(0,0,0,0.3); 
            transform: translateY(-2px);
        }

        /* --- CONTENT CARD --- */
        .content-card {
            background: var(--bg-card); 
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-card);
            border-radius: 1rem; padding: 2.5rem; min-height: 500px;
        }
        /* UPDATED: Mobile padding override */
        @media (max-width: 768px) {
            .content-card { padding: 1.5rem; min-height: auto; }
        }
        
        .tab-content { display: none; line-height: 1.8; color: var(--text-main); font-size: 1.05rem; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }

        /* Typography & Components */
        h3 {
            font-size: 1.35rem; color: var(--text-main); margin: 2.5rem 0 1.25rem 0;
            font-weight: 800; border-left: 5px solid var(--accent-color); padding-left: 1rem;
            letter-spacing: -0.01em; line-height: 1.3;
        }
        h3:first-child { margin-top: 0; }
        p { margin-bottom: 1.2rem; }
        ul { padding-left: 1.5rem; margin-bottom: 1.5rem; }
        li { margin-bottom: 0.5rem; padding-left: 0.25rem; }
        strong { color: var(--text-main); font-weight: 700; }
        em { color: var(--text-muted); font-style: normal; font-weight: 600; font-size: 0.95em; }

        .box { 
            padding: 1.75rem; border-radius: 0.75rem; margin-bottom: 2rem; 
            border-left: 4px solid; background: var(--bg-box);
        }
        .box-red { background: var(--box-red-bg); border-color: var(--box-red-border); color: var(--box-red-text); }
        .box-green { background: var(--box-green-bg); border-color: var(--box-green-border); color: var(--box-green-text); }
        .box-blue { background: var(--box-blue-bg); border-color: var(--box-blue-border); color: var(--box-blue-text); }
        .box-purple { background: var(--box-purple-bg); border-color: var(--box-purple-border); color: var(--box-purple-text); }
        .box-yellow { background: var(--box-yellow-bg); border-color: var(--box-yellow-border); color: var(--box-yellow-text); }
        
        .box-title { 
            display: block; font-weight: 800; font-size: 0.85rem; text-transform: uppercase; 
            margin-bottom: 1rem; letter-spacing: 0.05em; opacity: 0.95; 
        }

        .pearl-box {
            background-color: var(--bg-box); border: 1px solid var(--box-purple-border);
            border-radius: 0.75rem; padding: 1.75rem; margin-bottom: 1.5rem;
            position: relative; overflow: hidden;
        }
        .pearl-box::before {
            content: "üíé"; position: absolute; right: 1rem; top: 1rem; font-size: 3rem; opacity: 0.1;
        }
        .pearl-title {
            color: var(--box-purple-text); font-weight: 800; font-size: 1.2rem;
            margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;
        }

        /* --- MOBILE --- */
        .menu-toggle { display: none; background: none; border: none; color: var(--text-main); font-size: 1.5rem; cursor: pointer; }
        .backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 35; backdrop-filter: blur(5px); }

        @media (max-width: 768px) {
            .menu-toggle { display: block; margin-right: 0.5rem; }
            h1 { font-size: 1rem; }
            .home-title { font-size: 2rem; }
            .nav-card { width: 100%; padding: 2rem 1rem; }
            
            #app-view aside { position: absolute; height: 100%; width: 85%; transform: translateX(-100%); }
            #app-view aside.open { transform: translateX(0); box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            .backdrop.open { display: block; }
            
            #app-view main { padding: 0 1rem 6rem 1rem; }
            
            .box, .pearl-box { padding: 1.25rem; }
            .tabs-wrapper { margin: 0 -1rem 1rem -1rem; padding-left: 1rem; padding-right: 1rem; }
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header>
        <div style="display: flex; align-items: center;">
            <button id="menuToggle" class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
            <div class="logo-area" onclick="goHome()">
                <span style="font-size: 1.2rem;">‚öïÔ∏è</span>
                <h1>Surgical Helper</h1>
                <span id="modeBadge" class="mode-badge" style="display:none">MODE</span>
            </div>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()">
            <svg id="sun-icon" style="display:none" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0a.996.996 0 000-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"></path></svg>
            <svg id="moon-icon" viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-3.03 0-5.5-2.47-5.5-5.5 0-1.82.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"></path></svg>
        </button>
    </header>

    <div class="main-container" style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
        <!-- HOME PAGE -->
        <div id="home-view">
            <h2 class="home-title">Surgical Helper</h2>
            <div class="card-container">
                <div class="nav-card" onclick="startApp('long')">
                    <div class="card-icon">üìñ</div>
                    <div class="card-title">Long Case</div>
                    <div class="card-desc">Detailed clerking notes, etiology, history, examinations, and management for ward rounds.</div>
                </div>
                <div class="nav-card" onclick="startApp('short')">
                    <div class="card-icon">‚ö°</div>
                    <div class="card-title">Short Case</div>
                    <div class="card-desc">Rapid examination steps, differential diagnosis, and focused management for clinical exams.</div>
                </div>
                <!-- ADDED: General Notes Card -->
                <div class="nav-card" onclick="startApp('general')">
                    <div class="card-icon">üìö</div>
                    <div class="card-title">General Notes</div>
                    <div class="card-desc">Quick references for Anatomy, Surgical Procedures, and Peri-operative Care.</div>
                </div>
            </div>
            <p id="loadingMsg" style="color: var(--text-muted); display:none;">Loading Data...</p>
        </div>

        <!-- APP PAGE -->
        <div id="app-view">
            <div class="backdrop" id="backdrop" onclick="toggleSidebar()"></div>
            
            <aside id="sidebar">
                <div class="search-box">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search...">
                </div>
                <div id="caseList" class="case-list"></div>
            </aside>

            <main>
                <div id="welcomeState" class="welcome-state">
                    <div style="font-size: 5rem; margin-bottom: 1.5rem; opacity: 0.3;">ü©ª</div>
                    <h2 id="welcomeTitle">Select a Topic</h2>
                    <p>Choose an item from the sidebar to view details.</p>
                </div>

                <div id="caseDetails" class="case-details">
                    <div class="details-header">
                        <div>
                            <div id="categoryTag" class="category-tag">Category</div>
                            <h2 id="caseTitle">Condition Name</h2>
                        </div>
                        <div class="header-actions">
                            <button class="case-btn" style="width:auto; padding:0.5rem 1rem; background:var(--bg-input);" onclick="copyContent()">
                                <span>Copy Text</span>
                            </button>
                        </div>
                    </div>

                    <div class="tabs-wrapper">
                        <div class="tabs" id="tabsContainer">
                            <!-- Tabs injected via JS -->
                        </div>
                    </div>

                    <div class="content-card" id="contentContainer">
                        <!-- Content injected via JS -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // --- THEME ---
        const body = document.documentElement;
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            body.setAttribute('data-theme', savedTheme);
            updateIcons(savedTheme);
        }
        function toggleTheme() {
            const current = body.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            updateIcons(next);
        }
        function updateIcons(theme) {
            document.getElementById('sun-icon').style.display = theme === 'light' ? 'block' : 'none';
            document.getElementById('moon-icon').style.display = theme === 'dark' ? 'block' : 'none';
        }
        initTheme();

        // --- APP STATE & DATA ---
        let appState = {
            mode: null, // 'long', 'short', or 'general'
            longData: [],
            shortData: [],
            generalData: [], // Added for general notes
            currentData: []
        };

        const els = {
            homeView: document.getElementById('home-view'),
            appView: document.getElementById('app-view'),
            caseList: document.getElementById('caseList'),
            welcomeState: document.getElementById('welcomeState'),
            caseDetails: document.getElementById('caseDetails'),
            sidebar: document.getElementById('sidebar'),
            backdrop: document.getElementById('backdrop'),
            modeBadge: document.getElementById('modeBadge'),
            tabsContainer: document.getElementById('tabsContainer'),
            contentContainer: document.getElementById('contentContainer'),
            menuToggle: document.getElementById('menuToggle')
        };

        // --- INITIALIZATION ---
        async function loadData() {
            document.getElementById('loadingMsg').style.display = 'block';
            try {
                // Add timestamp to prevent caching
                const timestamp = new Date().getTime();
                
                // Fetch all JSON files in parallel
                const [longRes, shortRes, generalRes] = await Promise.all([
                    fetch(`medical_data.json?v=${timestamp}`),
                    fetch(`short_case_data.json?v=${timestamp}`),
                    fetch(`general_notes_data.json?v=${timestamp}`) // Load new file
                ]);
                
                appState.longData = await longRes.json();
                appState.shortData = await shortRes.json();
                appState.generalData = await generalRes.json();
                
                document.getElementById('loadingMsg').style.display = 'none';
            } catch (e) {
                console.error("Error loading data", e);
                document.getElementById('loadingMsg').innerText = "Error loading data files. Please ensure .json files are present.";
            }
        }

        // --- NAVIGATION ---
        function goHome() {
            appState.mode = null;
            els.appView.style.display = 'none';
            els.homeView.style.display = 'flex'; // Use flex to center
            els.appView.classList.remove('active');
            els.modeBadge.style.display = 'none';
            els.menuToggle.style.display = 'none'; // Hide hamburger on home
        }

        function startApp(mode) {
            appState.mode = mode;
            // Determine which data source to use
            if (mode === 'long') appState.currentData = appState.longData;
            else if (mode === 'short') appState.currentData = appState.shortData;
            else if (mode === 'general') appState.currentData = appState.generalData;
            
            els.homeView.style.display = 'none';
            els.appView.style.display = 'flex'; // Use flex for layout
            
            // UI Updates
            let modeText = 'LONG CASE';
            if (mode === 'short') modeText = 'SHORT CASE';
            if (mode === 'general') modeText = 'GENERAL NOTES';
            
            els.modeBadge.innerText = modeText;
            els.modeBadge.style.display = 'block';
            els.welcomeState.style.display = 'flex';
            els.caseDetails.classList.remove('active');
            els.caseDetails.style.display = 'none';
            
            // Show hamburger if mobile
            if(window.innerWidth <= 768) els.menuToggle.style.display = 'block';

            renderSidebar();
        }

        // --- RENDERING ---
        function renderSidebar(filter = '') {
            els.caseList.innerHTML = '';
            const data = appState.currentData;
            
            const categories = [...new Set(data.map(item => item.category))];
            let foundAny = false;

            categories.forEach(cat => {
                const itemsInCat = data.filter(item => 
                    item.category === cat && 
                    item.name.toLowerCase().includes(filter.toLowerCase())
                );

                if (itemsInCat.length > 0) {
                    foundAny = true;
                    const header = document.createElement('div');
                    header.className = 'category-header';
                    header.innerText = cat;
                    els.caseList.appendChild(header);

                    itemsInCat.forEach(item => {
                        const btn = document.createElement('button');
                        btn.className = 'case-btn';
                        btn.innerText = item.name;
                        btn.onclick = () => selectCase(item.id, btn);
                        els.caseList.appendChild(btn);
                    });
                }
            });

            if (!foundAny && data.length > 0) {
                els.caseList.innerHTML = '<div style="padding:2rem; text-align:center; color:var(--text-muted);">No matches</div>';
            }
        }

        function selectCase(id, btnElement) {
            // Sidebar UI
            document.querySelectorAll('.case-btn').forEach(b => b.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');

            // Find Data
            const data = appState.currentData.find(d => d.id === id);
            
            // Render Header
            document.getElementById('categoryTag').innerText = data.category;
            document.getElementById('caseTitle').innerText = data.name;

            // Render Tabs & Content based on Mode
            if (appState.mode === 'long') {
                renderLongCase(data);
            } else if (appState.mode === 'short') {
                renderShortCase(data);
            } else {
                renderGeneralNotes(data); // New renderer
            }

            // View Updates
            els.welcomeState.style.display = 'none';
            els.caseDetails.style.display = 'block';
            setTimeout(() => els.caseDetails.classList.add('active'), 10);
            
            // Mobile Sidebar handling
            if(window.innerWidth <= 768) toggleSidebar(false);
            document.querySelector('main').scrollTop = 0;
        }

        function renderLongCase(data) {
            const tabConfig = [
                { id: 'clerking', label: 'üìù Clerking', class: 'clerking' },
                { id: 'history', label: 'üìú History', class: '' },
                { id: 'etiology', label: 'üß¨ Etiology', class: '' },
                { id: 'exam', label: 'ü©∫ Examination', class: '' },
                { id: 'inv', label: 'üî¨ Investigations', class: '' },
                { id: 'mgmt', label: 'üíä Management', class: '' },
                { id: 'complications', label: '‚ö†Ô∏è Complications', class: 'complications' },
                { id: 'pearls', label: 'üíé Pearls', class: 'pearls' }
            ];
            generateTabsAndContent(tabConfig, data);
        }

        function renderShortCase(data) {
            const tabConfig = [
                { id: 'steps', label: 'ü©∫ Steps', class: 'clerking' },
                { id: 'ddx', label: 'ü§î Diagnosis & Path', class: '' },
                { id: 'inv', label: 'üî¨ Investigations', class: '' },
                { id: 'mgmt', label: 'üíä Management', class: '' }
            ];
            generateTabsAndContent(tabConfig, data);
        }

        // New function to render general notes
        function renderGeneralNotes(data) {
            const tabConfig = [
                { id: 'theory', label: 'üìò Theory/Anatomy', class: '' },
                { id: 'clinical', label: 'üè• Clinical Application', class: '' },
                { id: 'pearls', label: 'üíé Exam Pearls', class: 'pearls' }
            ];
            generateTabsAndContent(tabConfig, data);
        }

        function generateTabsAndContent(config, data) {
            // Clear
            els.tabsContainer.innerHTML = '';
            els.contentContainer.innerHTML = '';

            config.forEach((tab, index) => {
                // Create Button
                const btn = document.createElement('button');
                btn.className = `tab-btn ${tab.class} ${index === 0 ? 'active' : ''}`;
                btn.innerText = tab.label;
                btn.onclick = () => switchTab(tab.id, btn);
                els.tabsContainer.appendChild(btn);

                // Create Content Div
                const contentDiv = document.createElement('div');
                contentDiv.id = `tab-${tab.id}`;
                contentDiv.className = `tab-content ${index === 0 ? 'active' : ''}`;
                // Fallback text if data is missing for that tab
                contentDiv.innerHTML = data[tab.id] || '<div class="box box-blue">Content to be added...</div>';
                els.contentContainer.appendChild(contentDiv);
            });
        }

        function switchTab(tabId, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const target = document.getElementById(`tab-${tabId}`);
            if(target) target.classList.add('active');
        }

        // --- HELPERS ---
        function toggleSidebar(forceState) {
            const isOpen = els.sidebar.classList.contains('open');
            const shouldOpen = forceState !== undefined ? forceState : !isOpen;
            if (shouldOpen) {
                els.sidebar.classList.add('open');
                els.backdrop.classList.add('open');
            } else {
                els.sidebar.classList.remove('open');
                els.backdrop.classList.remove('open');
            }
        }

        function copyContent() {
            const title = document.getElementById('caseTitle').innerText;
            const strip = (html) => {
                let tmp = document.createElement("DIV");
                tmp.innerHTML = html;
                return tmp.innerText;
            };

            let text = `CONDITION: ${title}\n\n`;
            
            document.querySelectorAll('.tab-content').forEach(div => {
                const id = div.id.replace('tab-', '').toUpperCase();
                if(div.innerText.trim()) {
                    text += `[${id}]\n${strip(div.innerHTML)}\n\n`;
                }
            });
            
            navigator.clipboard.writeText(text).then(() => {
                alert("Case content copied to clipboard!");
            });
        }

        document.getElementById('searchInput').addEventListener('input', (e) => renderSidebar(e.target.value));

        // Start
        loadData();

    </script>
</body>
</html>
