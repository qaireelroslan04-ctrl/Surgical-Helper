<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Surgical Helper</title>

    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        /* --- 1. CSS VARIABLES --- */
        :root {
            /* Colors: Dark Mode (Default) */
            --bg-body: #000000;
            --bg-sidebar: #050505;
            --bg-card: #0a0a0a;
            --bg-box: #111111;
            --bg-input: #171717;
            --border-color: #27272a;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --accent-color: #3b82f6;
            --accent-bg: #172554;
            --accent-text: #bfdbfe;
            --header-bg: rgba(0, 0, 0, 0.85);
            --bg-tab: rgba(30, 30, 30, 0.6);
            --shadow-card: none;

            /* Colored Boxes (Dark) */
            --box-green-bg: rgba(6, 78, 59, 0.3); --box-green-border: #059669; --box-green-text: #d1fae5;
            --box-blue-bg: rgba(30, 58, 138, 0.3); --box-blue-border: #2563eb; --box-blue-text: #dbeafe;
            --box-red-bg: rgba(127, 29, 29, 0.3); --box-red-border: #dc2626; --box-red-text: #fee2e2;
            --box-purple-bg: rgba(88, 28, 135, 0.3); --box-purple-border: #9333ea; --box-purple-text: #f3e8ff;
            --box-yellow-bg: rgba(120, 53, 15, 0.3); --box-yellow-border: #d97706; --box-yellow-text: #fef3c7;
        }

        [data-theme="light"] {
            /* Colors: Light Mode */
            --bg-body: #f0f4f8;
            --bg-sidebar: #ffffff;
            --bg-card: #ffffff;
            --bg-box: #f8fafc;
            --bg-input: #f1f5f9;
            --border-color: #e2e8f0;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --accent-color: #0284c7;
            --accent-bg: #e0f2fe;
            --accent-text: #0c4a6e;
            --header-bg: rgba(255, 255, 255, 0.95);
            --bg-tab: rgba(255, 255, 255, 0.85);
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);

            /* Colored Boxes (Light) */
            --box-green-bg: #f0fdf4; --box-green-border: #22c55e; --box-green-text: #14532d;
            --box-blue-bg: #eff6ff; --box-blue-border: #3b82f6; --box-blue-text: #1e3a8a;
            --box-red-bg: #fef2f2; --box-red-border: #ef4444; --box-red-text: #7f1d1d;
            --box-purple-bg: #faf5ff; --box-purple-border: #a855f7; --box-purple-text: #581c87;
            --box-yellow-bg: #fffbeb; --box-yellow-border: #f59e0b; --box-yellow-text: #78350f;
        }

        /* --- 2. RESET & BASE --- */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.6;
        }

        /* --- 3. HEADER & TRANSITIONS --- */
        header {
            background-color: var(--header-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 0 1.5rem;
            height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            z-index: 50;
            flex-shrink: 0;
            transition: border-color 0.3s;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            height: 100%;
            flex: 1;
            overflow: hidden;
        }

        .logo-icon {
            font-size: 1.2rem;
            cursor: pointer;
            flex-shrink: 0;
        }

        .title-container {
            position: relative;
            height: 100%;
            display: flex;
            align-items: center;
            flex: 1;
        }

        .app-title {
            font-size: 1.25rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            color: var(--accent-color);
            position: absolute;
            left: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0);
            opacity: 1;
            white-space: nowrap;
        }

        .dynamic-header-info {
            position: absolute;
            left: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(100%);
            opacity: 0;
            pointer-events: none;
            line-height: 1.1;
        }

        .header-case-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .header-case-cat {
            font-size: 0.7rem;
            color: var(--accent-color);
            font-weight: 600;
            text-transform: uppercase;
        }

        header.scrolled .app-title { transform: translateY(-150%); opacity: 0; }
        header.scrolled .dynamic-header-info { transform: translateY(0); opacity: 1; }

        .mode-badge { 
            background: var(--bg-input); color: var(--text-muted); border: 1px solid var(--border-color);
            font-size: 0.65rem; padding: 2px 8px; border-radius: 4px; font-weight: 600; text-transform: uppercase; 
            margin-left: 10px; transition: opacity 0.2s;
        }
        header.scrolled .mode-badge { opacity: 0; pointer-events: none; }

        .theme-toggle {
            background: none; border: 1px solid var(--border-color); color: var(--text-main);
            cursor: pointer; padding: 0.5rem; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; width: 40px; height: 40px;
        }
        .theme-toggle svg { width: 20px; height: 20px; fill: currentColor; }

        /* --- 4. HOME VIEW --- */
        #home-view {
            display: flex; flex: 1;
            flex-direction: column; align-items: center; justify-content: center;
            gap: 3rem; padding: 2rem;
            animation: fadeIn 0.5s ease-out;
            overflow-y: auto;
        }
        .home-title {
            font-size: 2.5rem; font-weight: 900; text-align: center;
            background: linear-gradient(135deg, var(--accent-color), var(--box-purple-border));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .menu-list {
            display: flex; flex-direction: column; gap: 1rem;
            width: 100%; max-width: 400px;
        }
        .menu-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 1.2rem 1.5rem; background: var(--bg-card);
            border: 1px solid var(--border-color); border-radius: 0.75rem;
            cursor: pointer; transition: all 0.2s ease; text-align: left;
        }
        .menu-item:hover {
            border-color: var(--accent-color); transform: translateX(5px);
            background: var(--bg-input);
        }
        .menu-text { display: flex; flex-direction: column; }
        .menu-label { font-weight: 700; font-size: 1.1rem; color: var(--text-main); }
        .menu-sub { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.2rem; }
        .menu-icon { font-size: 1.5rem; opacity: 0.8; }

        /* --- 5. APP VIEW & LAYOUT --- */
        #app-view { 
            display: none; flex: 1; 
            overflow: hidden; position: relative; min-height: 0;
        } 
        
        /* Sidebar */
        aside {
            width: 340px; background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column;
            overflow-y: auto; -webkit-overflow-scrolling: touch;
            z-index: 40; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        .search-box {
            padding: 1rem; background: var(--bg-sidebar);
            position: sticky; top: 0; z-index: 5;
            border-bottom: 1px solid var(--border-color);
        }
        .search-input {
            width: 100%; padding: 0.85rem;
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            border-radius: 0.5rem; font-size: 0.95rem; outline: none;
            transition: border-color 0.2s;
        }
        .search-input:focus { border-color: var(--accent-color); }
        
        .case-list { padding: 0.5rem; padding-bottom: 3rem; }
        
        .category-header {
            font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em;
            color: var(--text-muted); font-weight: 800;
            padding: 1.5rem 0.5rem 0.5rem 0.75rem; margin-top: 0.5rem;
            border-bottom: 1px solid var(--border-color); opacity: 0.9;
        }
        .category-header:first-child { margin-top: 0; padding-top: 0.5rem; }

        .case-btn {
            width: 100%; text-align: left; padding: 1rem 0.75rem;
            background: none; border: none; cursor: pointer;
            color: var(--text-main); font-weight: 500; font-size: 0.95rem;
            border-radius: 0.5rem; margin-bottom: 4px; transition: all 0.2s;
        }
        .case-btn:hover { background-color: var(--bg-input); }
        .case-btn.active {
            background-color: var(--accent-bg); color: var(--accent-text);
            font-weight: 700; border-left: 3px solid var(--accent-color);
        }

        /* Main Content Area */
        main {
            flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
            padding: 0 2rem 0 2rem; background-color: var(--bg-body);
            scroll-behavior: smooth;
        }

        .welcome-state {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; text-align: center; color: var(--text-muted); padding: 2rem;
        }

        .case-details { max-width: 1000px; margin: 0 auto; display: none; }
        .case-details.active { display: block; animation: fadeIn 0.4s ease-in-out; }

        .details-header {
            margin-bottom: 1rem; border-bottom: 1px solid var(--border-color);
            padding: 2rem 0 1rem 0; display: flex; flex-direction: column; gap: 0.5rem;
        }
        .category-tag { font-size: 0.8rem; color: var(--accent-color); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        h2 { font-size: 2rem; color: var(--text-main); font-weight: 800; line-height: 1.2; margin: 0; }
        
        /* --- 6. CONTENT COMPONENTS --- */
        /* Images */
        .case-feature-img {
            width: 100%; max-height: 500px; object-fit: contain;
            background-color: var(--bg-box); border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            display: block; margin: 0 auto;
        }

        /* Floating Tabs */
        .tabs-wrapper {
            position: sticky; top: 0; z-index: 10;
            padding: 0.75rem 0; background-color: var(--bg-body);
            border-bottom: 1px solid var(--border-color);
            margin: 0 -2rem 1.5rem -2rem; 
            padding-left: 2rem; padding-right: 2rem;
        }
        .tabs {
            display: flex; padding: 0.25rem 0;
            overflow-x: auto; gap: 0.75rem;
            scrollbar-width: none; -ms-overflow-style: none;
        }
        .tabs::-webkit-scrollbar { display: none; }
        
        .tab-btn {
            flex: 0 0 auto; padding: 0.65rem 1.2rem; 
            border: 1px solid var(--border-color); 
            background: var(--bg-tab);
            cursor: pointer; border-radius: 2rem; 
            font-weight: 600; color: var(--text-muted);
            font-size: 0.9rem; white-space: nowrap; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; align-items: center; gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .tab-btn:hover { background: var(--bg-input); color: var(--text-main); transform: translateY(-1px); }
        .tab-btn.active { 
            background: var(--bg-card); color: var(--text-main); 
            border-color: var(--accent-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            transform: translateY(-1px);
        }

        /* Content Card */
        .content-card {
            background: var(--bg-card); 
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-card);
            border-radius: 1rem; padding: 2.5rem; min-height: 500px;
            touch-action: pan-y pinch-zoom;
        }
        .tab-content { 
            display: none; line-height: 1.8; color: var(--text-main); 
            font-size: 1.05rem;
            -webkit-hyphens: auto; -ms-hyphens: auto; hyphens: auto;
            overflow-wrap: break-word; word-wrap: break-word;
            text-align: left;
        }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }

        /* Typography & Helper Boxes */
        h3 {
            font-size: 1.35rem; color: var(--text-main); margin: 2.5rem 0 1.25rem 0;
            font-weight: 800; border-left: 5px solid var(--accent-color); padding-left: 1rem;
            letter-spacing: -0.01em; line-height: 1.3;
        }
        h3:first-child { margin-top: 0; }
        p { margin-bottom: 1.2rem; }
        ul { padding-left: 1.5rem; margin-bottom: 1.5rem; }
        li { margin-bottom: 0.5rem; padding-left: 0.25rem; }
        strong { color: var(--text-main); font-weight: 700; }
        em { color: var(--text-muted); font-style: normal; font-weight: 600; font-size: 0.95em; }

        .box { 
            padding: 1.75rem; border-radius: 0.75rem; margin-bottom: 2rem; 
            border-left: 4px solid; background: var(--bg-box);
        }
        .box-red { background: var(--box-red-bg); border-color: var(--box-red-border); color: var(--box-red-text); }
        .box-green { background: var(--box-green-bg); border-color: var(--box-green-border); color: var(--box-green-text); }
        .box-blue { background: var(--box-blue-bg); border-color: var(--box-blue-border); color: var(--box-blue-text); }
        .box-purple { background: var(--box-purple-bg); border-color: var(--box-purple-border); color: var(--box-purple-text); }
        .box-yellow { background: var(--box-yellow-bg); border-color: var(--box-yellow-border); color: var(--box-yellow-text); }
        
        .box-title { 
            display: block; font-weight: 800; font-size: 0.85rem; text-transform: uppercase; 
            margin-bottom: 1rem; letter-spacing: 0.05em; opacity: 0.95; 
        }

        .pearl-box {
            background-color: var(--bg-box); border: 1px solid var(--box-purple-border);
            border-radius: 0.75rem; padding: 1.75rem; margin-bottom: 1.5rem;
            position: relative; overflow: hidden;
        }
        .pearl-box::before {
            content: "üíé"; position: absolute; right: 1rem; top: 1rem; font-size: 3rem; opacity: 0.1;
        }
        .pearl-title {
            color: var(--box-purple-text); font-weight: 800; font-size: 1.2rem;
            margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;
        }

        /* Footer Nav & Scrolling */
        .scroll-spacer {
            height: 25vh; width: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 1rem; opacity: 0.5; transition: opacity 0.3s; margin-top: 1rem;
        }
        .scroll-line {
            width: 1px; height: 40px;
            background: linear-gradient(to bottom, transparent, var(--border-color), transparent);
        }
        .scroll-text {
            font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.15em;
            color: var(--text-muted); animation: pulse 2s infinite;
        }

        .footer-nav {
            margin-top: 0; display: flex; justify-content: space-between; gap: 1rem;
            padding-bottom: 4rem; opacity: 0; transform: translateY(20px);
            pointer-events: none; transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }
        .footer-nav.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }

        .nav-btn {
            flex: 1; padding: 1rem; background: var(--bg-card);
            border: 1px solid var(--border-color); border-radius: 0.75rem;
            color: var(--text-main); cursor: pointer;
            display: flex; align-items: center; gap: 0.5rem;
            transition: all 0.2s; font-weight: 600; font-size: 0.9rem; max-width: 48%;
        }
        .nav-btn:hover { border-color: var(--accent-color); background: var(--bg-input); }
        .nav-btn-prev { text-align: left; }
        .nav-btn-next { text-align: right; justify-content: flex-end; }
        .nav-btn-content { display: flex; flex-direction: column; overflow: hidden; }
        .nav-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .nav-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- 7. MOBILE & UTILITIES --- */
        .menu-toggle { display: none; background: none; border: none; color: var(--text-main); font-size: 1.5rem; cursor: pointer; }
        .backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 35; backdrop-filter: blur(5px); }

        @media (max-width: 768px) {
            .menu-toggle { display: block; margin-right: 0.5rem; }
            .app-title { font-size: 1rem; }
            .home-title { font-size: 2rem; }
            .menu-list { max-width: 100%; }
            
            #app-view aside { position: absolute; height: 100%; width: 85%; transform: translateX(-100%); }
            #app-view aside.open { transform: translateX(0); box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            .backdrop.open { display: block; }
            
            #app-view main { padding: 0 1rem 0 1rem; }
            .content-card { padding: 1.5rem; min-height: auto; }
            .box, .pearl-box { padding: 1.25rem; }
            .tabs-wrapper { margin: 0 -1rem 1rem -1rem; padding-left: 1rem; padding-right: 1rem; }
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    </style>
</head>
<body lang="en">

    <header id="mainHeader">
        <div class="header-left">
            <button id="menuToggle" class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
            
            <div class="logo-icon" onclick="goHome(true)">‚öïÔ∏è</div>

            <div class="title-container" onclick="goHome(true)">
                <h1 class="app-title">Surgical Helper <span id="modeBadge" class="mode-badge" style="display:none">MODE</span></h1>
                
                <div class="dynamic-header-info">
                    <span id="headerCaseTitle" class="header-case-title">Case Name</span>
                    <span id="headerCaseCat" class="header-case-cat">Category</span>
                </div>
            </div>
        </div>

        <button class="theme-toggle" onclick="toggleTheme()">
            <svg id="sun-icon" style="display:none" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0a.996.996 0 000-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"></path></svg>
            <svg id="moon-icon" viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-3.03 0-5.5-2.47-5.5-5.5 0-1.82.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"></path></svg>
        </button>
    </header>

    <div class="main-container" style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
        <div id="home-view">
            <h2 class="home-title">Surgical Helper</h2>
            <div class="menu-list">
                <div class="menu-item" onclick="startApp('long', true)">
                    <div class="menu-text">
                        <span class="menu-label">Long Case</span>
                        <span class="menu-sub">Detailed clerking & management</span>
                    </div>
                    <div class="menu-icon">üìñ</div>
                </div>
                <div class="menu-item" onclick="startApp('short', true)">
                    <div class="menu-text">
                        <span class="menu-label">Short Case</span>
                        <span class="menu-sub">Examination & rapid diagnosis</span>
                    </div>
                    <div class="menu-icon">‚ö°</div>
                </div>
                <div class="menu-item" onclick="startApp('general', true)">
                    <div class="menu-text">
                        <span class="menu-label">General Notes</span>
                        <span class="menu-sub">Anatomy, Pathology & Theory</span>
                    </div>
                    <div class="menu-icon">üìö</div>
                </div>
            </div>
            <p id="loadingMsg" style="color: var(--text-muted); display:none;">Loading Data...</p>
        </div>

        <div id="app-view">
            <div class="backdrop" id="backdrop" onclick="toggleSidebar()"></div>
            
            <aside id="sidebar">
                <div class="search-box">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search...">
                </div>
                <div id="caseList" class="case-list"></div>
            </aside>

            <main>
                <div id="welcomeState" class="welcome-state">
                    <div style="font-size: 5rem; margin-bottom: 1.5rem; opacity: 0.3;">ü©ª</div>
                    <h2 id="welcomeTitle">Select a Topic</h2>
                    <p>Choose an item from the sidebar to view details.</p>
                </div>

                <div id="caseDetails" class="case-details">
                    <div class="details-header">
                        <div>
                            <div id="categoryTag" class="category-tag">Category</div>
                            <h2 id="caseTitle">Condition Name</h2>
                        </div>
                    </div>

                    <div id="featureImageContainer" style="display: none; margin-bottom: 1.5rem;"></div>

                    <div class="tabs-wrapper">
                        <div class="tabs" id="tabsContainer"></div>
                    </div>

                    <div class="content-card" id="contentContainer"></div>

                    <div class="scroll-spacer">
                        <div class="scroll-line"></div>
                        <span id="scrollHint" class="scroll-text">Scroll for Navigation</span>
                    </div>

                    <div id="footerNav" class="footer-nav"></div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // --- 1. GLOBAL STATE & ELEMENTS ---
        let appState = {
            mode: null, 
            longData: [],
            shortData: [],
            generalData: [],
            currentData: []
        };

        const els = {
            body: document.documentElement,
            homeView: document.getElementById('home-view'),
            appView: document.getElementById('app-view'),
            caseList: document.getElementById('caseList'),
            welcomeState: document.getElementById('welcomeState'),
            caseDetails: document.getElementById('caseDetails'),
            sidebar: document.getElementById('sidebar'),
            backdrop: document.getElementById('backdrop'),
            modeBadge: document.getElementById('modeBadge'),
            tabsContainer: document.getElementById('tabsContainer'),
            contentContainer: document.getElementById('contentContainer'),
            menuToggle: document.getElementById('menuToggle'),
            featureImageContainer: document.getElementById('featureImageContainer'),
            footerNav: document.getElementById('footerNav'),
            mainHeader: document.getElementById('mainHeader'),
            headerCaseTitle: document.getElementById('headerCaseTitle'),
            headerCaseCat: document.getElementById('headerCaseCat'),
            sunIcon: document.getElementById('sun-icon'),
            moonIcon: document.getElementById('moon-icon'),
            scrollHint: document.getElementById('scrollHint'),
            searchInput: document.getElementById('searchInput')
        };

        const mainScrollArea = document.querySelector('main');

        // --- 2. THEME HANDLING ---
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            els.body.setAttribute('data-theme', savedTheme);
            updateIcons(savedTheme);
        }

        function toggleTheme() {
            const current = els.body.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            els.body.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            updateIcons(next);
        }

        function updateIcons(theme) {
            els.sunIcon.style.display = theme === 'light' ? 'block' : 'none';
            els.moonIcon.style.display = theme === 'dark' ? 'block' : 'none';
        }
        initTheme();

        // --- 3. DATA LOADING ---
        async function loadData() {
            document.getElementById('loadingMsg').style.display = 'block';
            try {
                const timestamp = new Date().getTime();
                
                const [longRes, shortRes, generalRes] = await Promise.all([
                    fetch(`medical_data.json?v=${timestamp}`),
                    fetch(`short_case_data.json?v=${timestamp}`),
                    fetch(`general_notes_data.json?v=${timestamp}`)
                ]);
                
                appState.longData = await longRes.json();
                appState.shortData = await shortRes.json();
                appState.generalData = await generalRes.json();
                
                document.getElementById('loadingMsg').style.display = 'none';
                
                if(!history.state) {
                    history.replaceState({ view: 'home' }, '');
                }
                
            } catch (e) {
                console.error("Error loading data", e);
                document.getElementById('loadingMsg').innerText = "Error loading data files. Please ensure .json files are present.";
            }
        }

        // --- 4. SCROLL LOGIC ---
        function checkScrollPosition() {
            const scrollTop = mainScrollArea.scrollTop;
            const clientHeight = mainScrollArea.clientHeight;
            const scrollHeight = mainScrollArea.scrollHeight;

            // Footer Nav Visibility
            const bottomThreshold = 40;
            if (scrollTop + clientHeight >= scrollHeight - bottomThreshold) {
                els.footerNav.classList.add('visible');
                if(els.scrollHint) els.scrollHint.style.opacity = '0';
            } else {
                els.footerNav.classList.remove('visible');
                if(els.scrollHint) els.scrollHint.style.opacity = '1';
            }

            // Header Transformation
            if (els.caseDetails.style.display !== 'none') {
                if (scrollTop > 80) {
                    els.mainHeader.classList.add('scrolled');
                } else {
                    els.mainHeader.classList.remove('scrolled');
                }
            } else {
                els.mainHeader.classList.remove('scrolled');
            }
        }

        mainScrollArea.addEventListener('scroll', checkScrollPosition);
        window.addEventListener('resize', checkScrollPosition);

        // --- 5. SWIPE GESTURES ---
        // Sidebar Swipe
        let globalTouchStartX = 0;
        let globalTouchStartY = 0;

        document.addEventListener('touchstart', (e) => {
            globalTouchStartX = e.touches[0].clientX;
            globalTouchStartY = e.touches[0].clientY;
        }, { passive: true });

        document.addEventListener('touchend', (e) => {
            const endX = e.changedTouches[0].clientX;
            const endY = e.changedTouches[0].clientY;
            
            const isLeftEdgeStart = globalTouchStartX < 40; 
            const isSwipeRight = (endX - globalTouchStartX) > 60;
            const isHorizontal = Math.abs(endY - globalTouchStartY) < 50;

            if (isLeftEdgeStart && isSwipeRight && isHorizontal) {
                if (!els.sidebar.classList.contains('open') && els.appView.style.display === 'flex') {
                    toggleSidebar(true);
                }
            }
        }, { passive: true });

        // Content Tab Swipe
        let contentTouchStartX = 0;
        let contentTouchStartY = 0; // Fix 3: Track Vertical Start
        let contentTouchEndX = 0;
        const MIN_SWIPE_DISTANCE = 60;

        els.contentContainer.addEventListener('touchstart', e => {
            contentTouchStartX = e.changedTouches[0].screenX;
            contentTouchStartY = e.changedTouches[0].screenY; // Fix 3: Track Vertical Start
        }, { passive: true });

        els.contentContainer.addEventListener('touchend', e => {
            contentTouchEndX = e.changedTouches[0].screenX;
            const contentTouchEndY = e.changedTouches[0].screenY; // Fix 3: Track Vertical End
            handleContentSwipe(contentTouchEndY);
        }, { passive: true });

        function handleContentSwipe(endY) {
            if (els.caseDetails.style.display === 'none') return;

            const diffX = contentTouchStartX - contentTouchEndX;
            const diffY = contentTouchStartY - endY;

            // Fix 3: Sensitivity Check - If vertical scroll > horizontal swipe, ignore the swipe.
            // This prevents accidental swipes when reading down the page.
            if (Math.abs(diffY) > Math.abs(diffX)) return;

            const currentActiveBtn = document.querySelector('.tab-btn.active');
            if (!currentActiveBtn) return;

            // Swipe Left (Show Next Tab)
            if (diffX > MIN_SWIPE_DISTANCE) {
                const nextBtn = currentActiveBtn.nextElementSibling;
                if (nextBtn && nextBtn.classList.contains('tab-btn')) {
                    nextBtn.click();
                    nextBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            } 
            // Swipe Right (Show Prev Tab)
            else if (diffX < -MIN_SWIPE_DISTANCE) {
                const prevBtn = currentActiveBtn.previousElementSibling;
                if (prevBtn && prevBtn.classList.contains('tab-btn')) {
                    prevBtn.click();
                    prevBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            }
        }

        // --- 6. NAVIGATION & HISTORY ---
        window.onpopstate = function(event) {
            if (!event.state || event.state.view === 'home') {
                goHome(false);
            } else if (event.state.view === 'app') {
                startApp(event.state.mode, false);
            } else if (event.state.view === 'case') {
                if (appState.mode !== event.state.mode) {
                    startApp(event.state.mode, false);
                }
                selectCase(event.state.id, null, false);
            }
        };

        function goHome(addToHistory = false) {
            appState.mode = null;
            els.appView.style.display = 'none';
            els.homeView.style.display = 'flex';
            els.appView.classList.remove('active');
            els.modeBadge.style.display = 'none';
            els.menuToggle.style.display = 'none';
            els.mainHeader.classList.remove('scrolled');
            
            if (addToHistory) {
                history.pushState({ view: 'home' }, '', '#home');
            }
        }

        function startApp(mode, addToHistory = false) {
            appState.mode = mode;
            if (mode === 'long') appState.currentData = appState.longData;
            else if (mode === 'short') appState.currentData = appState.shortData;
            else if (mode === 'general') appState.currentData = appState.generalData;
            
            if (addToHistory) {
                history.pushState({ view: 'app', mode: mode }, '', `#${mode}`);
            }

            els.homeView.style.display = 'none';
            els.appView.style.display = 'flex'; 
            
            let modeText = 'LONG CASE';
            if (mode === 'short') modeText = 'SHORT CASE';
            if (mode === 'general') modeText = 'GENERAL NOTES';
            
            els.modeBadge.innerText = modeText;
            els.modeBadge.style.display = 'inline-block';
            els.welcomeState.style.display = 'flex';
            els.caseDetails.classList.remove('active');
            els.caseDetails.style.display = 'none';
            els.mainHeader.classList.remove('scrolled');
            
            if(window.innerWidth <= 768) els.menuToggle.style.display = 'block';

            renderSidebar();
        }

        // --- 7. RENDERING LOGIC ---
        function renderSidebar(filter = '') {
            els.caseList.innerHTML = '';
            const data = appState.currentData;
            
            const categories = [...new Set(data.map(item => item.category))];
            let foundAny = false;

            categories.forEach(cat => {
                const itemsInCat = data.filter(item => 
                    item.category === cat && 
                    item.name.toLowerCase().includes(filter.toLowerCase())
                );

                if (itemsInCat.length > 0) {
                    foundAny = true;
                    const header = document.createElement('div');
                    header.className = 'category-header';
                    header.innerText = cat;
                    els.caseList.appendChild(header);

                    itemsInCat.forEach(item => {
                        const btn = document.createElement('button');
                        btn.className = 'case-btn';
                        btn.innerText = item.name;
                        btn.onclick = () => selectCase(item.id, btn, true);
                        els.caseList.appendChild(btn);
                    });
                }
            });

            if (!foundAny && data.length > 0) {
                els.caseList.innerHTML = '<div style="padding:2rem; text-align:center; color:var(--text-muted);">No matches</div>';
            }
        }

        function selectCase(id, btnElement, addToHistory = false) {
            document.querySelectorAll('.case-btn').forEach(b => b.classList.remove('active'));
            if (btnElement) btnElement.classList.add('active');

            const data = appState.currentData.find(d => d.id === id);
            if (!data) return;

            if (addToHistory) {
                history.pushState({ view: 'case', mode: appState.mode, id: id }, '', `#${appState.mode}/${id}`);
            }

            // Update Header Information
            document.getElementById('categoryTag').innerText = data.category;
            document.getElementById('caseTitle').innerText = data.name;
            els.headerCaseTitle.innerText = data.name;
            els.headerCaseCat.innerText = data.category;

            // Handle Feature Image
            els.featureImageContainer.innerHTML = '';
            els.featureImageContainer.style.display = 'none';

            // Fix 2: Added onerror handler to hide container if image fails
            if (data.image && data.image.trim() !== "") {
                els.featureImageContainer.style.display = 'block';
                els.featureImageContainer.innerHTML = `
                    <img src="${data.image}" 
                         class="case-feature-img" 
                         alt="${data.name} Diagram" 
                         loading="lazy"
                         onerror="this.parentElement.style.display='none'"> 
                `;
            }

            // Render Specific Mode Content
            if (appState.mode === 'long') renderLongCase(data);
            else if (appState.mode === 'short') renderShortCase(data);
            else renderGeneralNotes(data);

            renderFooterNavigation(id);

            els.welcomeState.style.display = 'none';
            els.caseDetails.style.display = 'block';
            setTimeout(() => els.caseDetails.classList.add('active'), 10);
            
            if(window.innerWidth <= 768) toggleSidebar(false);
            
            // Fix 1: Reset Page Scroll AND Tab Scroll
            mainScrollArea.scrollTo({top: 0, behavior: 'auto'});
            els.tabsContainer.scrollTo({left: 0, behavior: 'auto'});
            checkScrollPosition();
        }

        function renderFooterNavigation(currentId) {
            const container = els.footerNav;
            container.innerHTML = '';

            const data = appState.currentData;
            const idx = data.findIndex(d => d.id === currentId);
            
            if (idx === -1) return;

            const prev = data[idx - 1];
            const next = data[idx + 1];

            if (prev) {
                const btn = document.createElement('button');
                btn.className = 'nav-btn nav-btn-prev';
                const displayName = prev.name.length > 20 ? prev.name.substring(0, 18) + '...' : prev.name;
                
                btn.innerHTML = `
                    <span style="font-size:1.2rem; line-height:1">‚Üê</span>
                    <div class="nav-btn-content">
                        <span class="nav-label">Previous</span>
                        <span class="nav-title">${displayName}</span>
                    </div>
                `;
                btn.onclick = () => selectCase(prev.id, null, true);
                container.appendChild(btn);
            } else {
                const spacer = document.createElement('div');
                spacer.style.flex = "1";
                container.appendChild(spacer);
            }

            if (next) {
                const btn = document.createElement('button');
                btn.className = 'nav-btn nav-btn-next';
                const displayName = next.name.length > 20 ? next.name.substring(0, 18) + '...' : next.name;

                btn.innerHTML = `
                    <div class="nav-btn-content">
                        <span class="nav-label">Next</span>
                        <span class="nav-title">${displayName}</span>
                    </div>
                    <span style="font-size:1.2rem; line-height:1">‚Üí</span>
                `;
                btn.onclick = () => selectCase(next.id, null, true);
                container.appendChild(btn);
            }
        }

        function renderLongCase(data) {
            const tabConfig = [
                { id: 'clerking', label: 'üìù Clerking', class: 'clerking' },
                { id: 'history', label: 'üìú History', class: '' },
                { id: 'etiology', label: 'üß¨ Etiology', class: '' },
                { id: 'exam', label: 'ü©∫ Examination', class: '' },
                { id: 'inv', label: 'üî¨ Investigations', class: '' },
                { id: 'mgmt', label: 'üíä Management', class: '' },
                { id: 'complications', label: '‚ö†Ô∏è Complications', class: 'complications' },
                { id: 'pearls', label: 'üíé Pearls', class: 'pearls' }
            ];
            generateTabsAndContent(tabConfig, data);
        }

        function renderShortCase(data) {
            const tabConfig = [
                { id: 'steps', label: 'ü©∫ Steps', class: 'clerking' },
                { id: 'ddx', label: 'ü§î Diagnosis & Path', class: '' },
                { id: 'inv', label: 'üî¨ Investigations', class: '' },
                { id: 'mgmt', label: 'üíä Management', class: '' }
            ];
            generateTabsAndContent(tabConfig, data);
        }

        function renderGeneralNotes(data) {
            const ignoredKeys = ['id', 'category', 'name', 'image'];
            const keys = Object.keys(data).filter(k => !ignoredKeys.includes(k));
            
            const formatLabel = (str) => {
                return str.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
            };

            const priority = ['definition', 'etiology', 'pathophysiology', 'clinical_features', 'investigation', 'diagnosis', 'management'];
            
            keys.sort((a, b) => {
                let ia = priority.indexOf(a);
                let ib = priority.indexOf(b);
                if (ia === -1) ia = 999;
                if (ib === -1) ib = 999;
                return ia - ib;
            });

            const tabConfig = keys.map(key => ({
                id: key,
                label: formatLabel(key),
                content: data[key]
            }));

            generateTabsAndContent(tabConfig, data);
        }

        function generateTabsAndContent(config, data) {
            els.tabsContainer.innerHTML = '';
            els.contentContainer.innerHTML = '';

            config.forEach((tab, index) => {
                if(!tab.content && !data[tab.id]) return;
                
                const btn = document.createElement('button');
                const isActive = index === 0;
                btn.className = `tab-btn ${isActive ? 'active' : ''}`;
                btn.innerText = tab.label;
                btn.onclick = () => switchTab(tab.id, btn);
                els.tabsContainer.appendChild(btn);

                const contentDiv = document.createElement('div');
                contentDiv.id = `tab-${tab.id}`;
                contentDiv.className = `tab-content ${isActive ? 'active' : ''}`;
                contentDiv.innerHTML = tab.content || data[tab.id];
                els.contentContainer.appendChild(contentDiv);
            });
        }

        function switchTab(tabId, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const target = document.getElementById(`tab-${tabId}`);
            if(target) target.classList.add('active');
            
            mainScrollArea.scrollTo({ top: 0, behavior: 'auto' });
            checkScrollPosition(); 
        }

        function toggleSidebar(forceState) {
            const isOpen = els.sidebar.classList.contains('open');
            const shouldOpen = forceState !== undefined ? forceState : !isOpen;
            if (shouldOpen) {
                els.sidebar.classList.add('open');
                els.backdrop.classList.add('open');
            } else {
                els.sidebar.classList.remove('open');
                els.backdrop.classList.remove('open');
            }
        }

        els.searchInput.addEventListener('input', (e) => renderSidebar(e.target.value));
        loadData();

    </script>
</body>
</html>
